# setup_dataset.py ソフトウェア仕様書

**プロジェクト**: カブトムシ検出データセット セットアップスクリプト
**バージョン**: 1.0
**作成日**: 2025-12-25
**要件定義書**: insect_detection_application_test_project_requirements_spec.md (同ディレクトリ)

---

## 1. 概要

### 1.1 目的
手動でダウンロードしたRoboflowデータセット（ZIP形式）を展開し、YOLOv8訓練用のディレクトリ構成に配置するスクリプト。

### 1.2 スコープ
- ZIPファイルの検索と展開
- YOLOv8形式のディレクトリ構造検証
- データセット統計情報の表示

### 1.3 対象データセット
| 項目 | 内容 |
|------|------|
| 提供元 | Roboflow Universe |
| プロジェクト | z-algae-bilby/beetle |
| ライセンス | CC BY 4.0 |
| URL | https://universe.roboflow.com/z-algae-bilby/beetle/dataset/1 |

---

## 2. システム要件

### 2.1 動作環境
| 項目 | 要件 |
|------|------|
| OS | Linux (WSL2 Ubuntu推奨)、macOS、Windows |
| Python | 3.9以上 |

### 2.2 依存ライブラリ
すべてPython標準ライブラリのため、追加インストール不要。

| ライブラリ | 用途 |
|------------|------|
| argparse | コマンドライン引数の処理 |
| shutil | ファイルコピー操作 |
| sys | システム終了処理 |
| zipfile | ZIP展開処理 |
| pathlib | パス操作 |

---

## 3. 機能仕様

### 3.1 機能一覧

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-01 | ZIPファイル検索 | 指定ディレクトリ内のZIPファイルを自動検出 |
| F-02 | ZIP展開 | ZIPファイルを指定ディレクトリに展開 |
| F-03 | 構造検証 | YOLOv8形式のディレクトリ構造を検証 |
| F-04 | 統計表示 | データセットのファイル数を集計・表示 |
| F-05 | ダウンロード案内 | ZIPが見つからない場合の手順を表示 |

### 3.2 機能詳細

#### F-01: ZIPファイル検索
- `downloads/`ディレクトリ内の`.zip`拡張子ファイルを検索
- 複数のZIPファイルがある場合はユーザーに選択を求める
- ファイルサイズ（MB単位）を表示

#### F-02: ZIP展開
- 展開先ディレクトリが存在しない場合は自動作成
- 展開前にファイル数を表示
- エラー発生時は種類別にメッセージを表示

#### F-03: 構造検証
- 必須ディレクトリの存在確認
- `data.yaml`の存在確認（サブディレクトリにある場合はルートにコピー）
- 各ディレクトリ内のファイル数をカウント

#### F-04: 統計表示
- 訓練画像数、検証画像数、合計を表示
- テストディレクトリがある場合は追加表示

#### F-05: ダウンロード案内
- Roboflowからのダウンロード手順を表示
- フォーマット選択（YOLOv8）の指示を含む

---

## 4. インターフェース仕様

### 4.1 コマンドライン引数

| 引数 | 短縮形 | 型 | デフォルト | 説明 |
|------|--------|-----|------------|------|
| `--downloads` | `-d` | str | `downloads` | ZIPファイルの配置ディレクトリ |
| `--output` | `-o` | str | `datasets` | データセットの展開先ディレクトリ |
| `--delete-zip` | - | flag | False | 展開後にZIPファイルを削除 |
| `--help` | `-h` | - | - | ヘルプを表示 |

### 4.2 使用例

```bash
# 基本使用（デフォルト設定）
python3 setup_dataset.py

# カスタムディレクトリを指定
python3 setup_dataset.py --downloads my_downloads --output my_datasets

# 展開後にZIPを削除
python3 setup_dataset.py --delete-zip

# ヘルプを表示
python3 setup_dataset.py --help
```

---

## 5. 入出力仕様

### 5.1 入力

#### 入力ディレクトリ構造
```
downloads/
└── Beetle.v1i.yolov8.zip    # Roboflowからダウンロードしたデータセット
```

#### 対応ZIPファイル形式
- 拡張子: `.zip`
- 内容: YOLOv8形式のデータセット（Roboflowエクスポート）

### 5.2 出力

#### 展開後のディレクトリ構造
```
datasets/
├── data.yaml                 # YOLOv8設定ファイル
├── train/
│   ├── images/              # 訓練用画像（JPEG/PNG）
│   └── labels/              # 訓練用ラベル（YOLO形式txt）
├── valid/
│   ├── images/              # 検証用画像
│   └── labels/              # 検証用ラベル
└── test/                    # オプション
    ├── images/              # テスト用画像
    └── labels/              # テスト用ラベル
```

---

## 6. 関数仕様

### 6.1 関数一覧

| 関数名 | 説明 |
|--------|------|
| `find_zip_files()` | ZIPファイルを検索 |
| `extract_dataset()` | ZIPファイルを展開 |
| `verify_dataset_structure()` | ディレクトリ構造を検証 |
| `print_download_instructions()` | ダウンロード手順を表示 |
| `main()` | メイン処理 |

### 6.2 関数詳細

#### find_zip_files(downloads_dir)
```
引数:
    downloads_dir (str): ZIPファイルを探すディレクトリパス

戻り値:
    list[Path]: 見つかったZIPファイルのパスリスト（見つからない場合は空リスト）
```

#### extract_dataset(zip_path, output_dir)
```
引数:
    zip_path (Path): 展開するZIPファイルのパス
    output_dir (str): 展開先ディレクトリ

戻り値:
    bool: 展開成功時True、失敗時False
```

#### verify_dataset_structure(dataset_dir)
```
引数:
    dataset_dir (str): 検証するデータセットのディレクトリ

戻り値:
    bool: 必須構造が揃っている場合True、不足がある場合False
```

---

## 7. エラー処理

### 7.1 エラー一覧

| エラー種別 | 原因 | 対処方法 |
|------------|------|----------|
| ZIPファイル未検出 | `downloads/`にZIPがない | ダウンロード手順を表示して終了 |
| BadZipFile | ZIPファイルの破損 | ファイルを再ダウンロード |
| PermissionError | 書き込み権限なし | 出力ディレクトリの権限を確認 |
| KeyboardInterrupt | Ctrl+C押下 | 「キャンセルしました」と表示して終了 |

### 7.2 終了コード

| コード | 意味 |
|--------|------|
| 0 | 正常終了 |
| 1 | エラー終了（ZIPが見つからない、展開失敗など） |

---

## 8. 定数定義

| 定数名 | 値 | 説明 |
|--------|-----|------|
| `DOWNLOADS_DIR` | `"downloads"` | デフォルトのZIP配置ディレクトリ |
| `DATASETS_DIR` | `"datasets"` | デフォルトの展開先ディレクトリ |
| `DATASET_URL` | Roboflow URL | データセットのダウンロードURL |
| `DATASET_LICENSE` | `"CC BY 4.0"` | データセットのライセンス |
| `DATASET_AUTHOR` | `"z-algae-bilby"` | データセットの提供者 |

---

## 9. 処理フロー

```
開始
  │
  ├─ コマンドライン引数を解析
  │
  ├─ ヘッダーとライセンス情報を表示
  │
  ├─ ダウンロードディレクトリを確認（なければ作成）
  │
  ├─ ZIPファイルを検索
  │    │
  │    ├─ 見つからない → ダウンロード手順を表示 → 終了(1)
  │    │
  │    ├─ 1つ → そのファイルを選択
  │    │
  │    └─ 複数 → ユーザーに選択させる
  │
  ├─ ZIPファイルを展開
  │    │
  │    └─ 失敗 → エラーメッセージ → 終了(1)
  │
  ├─ データセット構造を検証
  │    │
  │    └─ 不足あり → 警告メッセージ（処理は継続）
  │
  ├─ ZIPファイルの処理（--delete-zipオプションに応じて削除または保持）
  │
  └─ 完了メッセージを表示 → 終了(0)
```

---

## 10. 検証項目

### 10.1 正常系テスト

| テストID | テスト内容 | 期待結果 |
|----------|------------|----------|
| T-01 | 正常なZIPファイルを展開 | datasets/に正しく展開される |
| T-02 | 複数ZIPから選択 | 選択したZIPのみ展開される |
| T-03 | --delete-zipオプション | 展開後にZIPが削除される |
| T-04 | カスタムディレクトリ指定 | 指定ディレクトリに展開される |

### 10.2 異常系テスト

| テストID | テスト内容 | 期待結果 |
|----------|------------|----------|
| T-05 | ZIPファイルなし | ダウンロード手順が表示される |
| T-06 | 破損したZIPファイル | エラーメッセージと再ダウンロードの案内 |
| T-07 | 書き込み権限なし | 権限エラーメッセージ |
| T-08 | Ctrl+Cで中断 | キャンセルメッセージ表示 |

---

## 11. 制限事項

- 自動ダウンロード機能は提供しない（手動ダウンロードが必要）
- Roboflow以外のデータセット形式は未検証
- ZIP内に複数のdata.yamlがある場合、最初に見つかったものを使用

---

## 12. 変更履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2025-12-25 | 初版作成 |

